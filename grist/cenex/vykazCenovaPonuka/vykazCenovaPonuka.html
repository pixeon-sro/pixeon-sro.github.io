<!DOCTYPE html>
<html lang="sk">
  <head>
    <meta charset="utf-8">
    <title>Výkaz cenová ponuka</title>
    <link href="../css/style.css" rel="stylesheet" />
    <link href="../css/stylePrinter.css" rel="stylesheet" media="print" />
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <!--<script src="-cp.js"></script>-->
    <script src="cp-example.js"></script>
  </head>
  <body>
    <pre id="myDisplay" style="background:red"></pre>

    <h1>Cenová ponuka</h1>
    <h2><strong>Dielo: </strong><span id="dielo"></span></h2>
    <h2><strong>Investor: </strong><span id="zakaznik"></span></h2>
    <h3>Kontaktné údaje</h3>
    <p>
      <strong>telefón: </strong><span id="telefon"></span><br/>
      <strong>e-mail: </strong><span id="mail"></span>
    </p>
    <p>
      <strong>Dátum vyhotovenia CP: </strong><span id="datumVytvorenia"></span><br/>
      <strong>Dátum platnosti CP: </strong><span id="datumPlatnosti"></span>
    </p>

    <h1>Výkaz Materiálu</h1>

    <table id="VykazVymerMaterial">
      <tr>
        <th>Etapa</th>
        <th>Materiál</th>
        <th>Jednotka</th>
        <th>Jednotková cena</th>
        <th>Množstvo</th>
        <th>Celková cena</th>
      </tr>
    </table>
    <!-- vynutene zalomenie strany pri tlaci  -->
    <div style="break-after:page"></div>

    <script>
    //verzia scriptu do konzoly
    console.log("*** vykazCenovaPonuka.html - ver: 026")

      // pomocná funkcia na zobrazenie premenných pri vývoji
      let myDisplay = function(zobraz) {
        document.getElementById("myDisplay").innerText = zobraz;
      }



//verzia scriptu
console.log("*** cp.js - ver: 055")

// grist požaduje plný prístup
grist.ready({ requiredAccess: 'full' })

// načítanie tabuľky CP
async function dataFromCP() {
    let dataFromCenex = await grist.docApi.fetchSelectedTable(options = {format:"rows"})
    return dataFromCenex
}
// vytvorenie objektu z CP
let dataCP = dataFromCP()
dataCP.then(
    function(value) { tabData(value) },
    function(error) { console.log(error) }
)

// načítanie tabuľky Etapa
async function dbTableEtapa() {
    let dataFromEtapa = await grist.docApi.fetchTable("Etapa")
    return dataFromEtapa
}
let dbEtapa = dbTableEtapa()
//dbEtapa.then(
//    function(value) { console.log(value) }
//)
let tabEtapa = tabFromDB(dbEtapa)

// načítanie tabuľky Materiál
async function dbTableMaterial() {
    let dataFromMaterial = await grist.docApi.fetchTable("Material")
    return dataFromMaterial
}
let dbMaterial = dbTableMaterial()
dbMaterial.then(
    function(value) { console.log(value) }
)

// načítanie tabuľky Práca
async function dbTablePraca() {
    let dataFromPraca = await grist.docApi.fetchTable("Praca")
    return dataFromPraca
}
let dbPraca =  dbTablePraca()
//dbPraca.then(
//    function(value) { console.log(value) }
//)
/* vytvorenie objektu z Práca
let dataPraca = dataFromPraca()
dataPraca.then(
    function(value) { console.log(value) },
    function(error) { console.log(error) }
)
*/

// načítanie tabuľky Pridružené Náklady
async function dataFromPridruzene_naklady() {
    let dataFromPridruzene_naklady = await grist.docApi.fetchTable("Pridruzene_naklady")
    return dataFromPridruzene_naklady
}
// vytvorenie objektu z Pridružené Náklady
let dataPridruzene_naklady = dataFromPridruzene_naklady()
//dataPridruzene_naklady.then(
//    function(value) { console.log(value) },
//    function(error) { console.log(error) }
//)


function tabFromDB (db) {
  db.then(function(value){
    let dbArray = Object.entries(value)
    console.log("<<<<<<<<<<<<<<<<<<<<<<<")
    console.log(dbArray)
    console.log("<<<<<<<<<<<<<<<<<<<<<<<")


    //let outValue = []

    dbArray.forEach(function(entries) {
      console.log("11111111111111111111")
      console.log(entries)
      entries.forEach(function(entri) {
        console.log("22222222222222222222")
        console.log(entri)
      })
    })
  })
}

//vytvorenie poľa objektov pre tlačové tabuľky
function tabData(value) {
    // referaencie z cenovej ponuky na ostatne tabulky
    let ref = value[0]
    let refMaterial = ref.References.Vykaz_Vymer_Material
    let refPraca = ref.References.Vykaz_Vymer_Praca
    let refNaklady = ref.References.Pridruzene_naklady
    let refCena = ref.References.Konecna_Cena
    let refEtapa = ref.References.Etapa

    function createMaterial(){
        let material = []
        refMaterial.forEach(function(row) {
            console.log("riadokz vytvarania materialu:")
            console.log(row)
            let item = {
                id:row.id,
                jednotka:row.jednotka,
                jednotkova_cena:row.jednotkova_cena,
                mnozstvo:row.mnozstvo,
                celkova_cena:row.celkova_cena
            }

            // insert etapa z tabulky Etapa
            function insertEtapa(value) {
                let insEtapa = value.Etapa[row.etapa.rowId-1]
                item.etapa = insEtapa
            }
            dbEtapa.then(function(value) { insertEtapa(value) })

            // insert material z tabulky Material
            function insertMaterial(value) {
                let insMaterial = value.nazov[row.material.rowId-1]
                item.material = insMaterial
            }
            dbMaterial.then(function(value) { insertMaterial(value) })
            material.push(item)
        })
        console.log("hotovy material:")
        console.log(material)
    }

    // vytvorenie tabuliek pre tlac
    let vykazVymerMaterial = createMaterial()


    function vykazVymerPraca(){return praca}
    function vykazPridruzeneNaklady(){return naklady}
    function vykazKonecnaCena(){return cena}
    function vykazEtapa(){return etapa}

    //console.log("******")
    //console.log(ref)
    //console.log("******")
    //console.log(ref.References)
    //console.log("******")
    //console.log(refMaterial)
    //console.log(refPraca)
    //console.log(refNaklady)
    //console.log(refCena)
    //console.log(refEtapa)
    //console.log("******")
}
    </script>

    <button onclick="window.print()">Tlačiť</button>
  </body>
</html>
